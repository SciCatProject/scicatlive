name: Docker Compose CI

on:  # yamllint disable-line rule:truthy
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - '**/mkdocs*'

jobs:
  get-changed-files:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v4
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files_ignore: '*.md'
  yaml-lint:
    runs-on: ubuntu-latest
    needs:
      - get-changed-files
    if: ${{ contains(needs.get-changed-files.outputs.changed_files, '.yaml') ||
        contains(needs.get-changed-files.outputs.changed_files, '.yml') }}
    steps:
      - uses: actions/checkout@v4
      - name: Install 'yamllint'
        run: sudo apt-get install -y yamllint
      - name: Lint YAML files
        run: yamllint -c .github/yamllint_config.yaml .
  json-lint:
    runs-on: ubuntu-latest
    needs:
      - get-changed-files
    if: ${{ contains(needs.get-changed-files.outputs.changed_files, '.json') }}
    steps:
      - uses: actions/checkout@v4
      - name: Install 'jsonlint' and 'git'
        run: sudo apt install python3-demjson git
      - name: Lint JSON files
        run: >-
          git ls-files -z '*.json' | xargs -0r jsonlint -s --allow=non-portable
  shell-lint:
    runs-on: ubuntu-latest
    needs:
      - get-changed-files
    if: ${{ contains(needs.get-changed-files.outputs.changed_files, '.sh') }}
    steps:
      - uses: actions/checkout@v4
      - name: Install 'shellcheck' and 'git'
        run: sudo apt install shellcheck git
      - name: Lint shell files ([ba]sh scripts)
        run: >-
          git ls-files -z '*.sh' '*.bash' '*.ksh' '*.bashrc' '*.bash_profile'
          '*.bash_login' '*.bash_logout' | xargs -0r shellcheck
  javascript-lint:
    runs-on: ubuntu-latest
    needs:
      - get-changed-files
    if: ${{ contains(needs.get-changed-files.outputs.changed_files, '.js') ||
        contains(needs.get-changed-files.outputs.changed_files, '.cjs') ||
        contains(needs.get-changed-files.outputs.changed_files, '.mjs') ||
        contains(needs.get-changed-files.outputs.changed_files, '.ts') }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: v20
      - name: install eslint and default rules
        run: npm install eslint @eslint/js --save-dev
      - name: Lint javascript files
        run: npx eslint --config .github/eslint.config.mjs
  test:
    runs-on: ubuntu-latest
    needs:
      - get-changed-files
      - yaml-lint
      - json-lint
      - shell-lint
      - javascript-lint
    if: ${{ ! failure() && ! cancelled() &&
        needs.get-changed-files.outputs.changed_files }}
    strategy:
      matrix:
        BE_VERSION: [v3, v4]
        ELASTIC_OR_JOBS_ENABLED: ['', true]
        LDAP_ENABLED: ['', true]
        OIDC_ENABLED: ['', true]
        DEV: ['', true]
        exclude:
          - BE_VERSION:
              ${{ (! contains(needs.get-changed-files.outputs.changed_files
              , 'v3')) && 'v3' || '' }}
          - BE_VERSION:
              ${{ (contains(needs.get-changed-files.outputs.changed_files
              , 'v3')) &&
              (! contains(needs.get-changed-files.outputs.changed_files
              , 'v4')) && 'v4' || ''}}
          - ELASTIC_OR_JOBS_ENABLED:
              ${{ (! contains(needs.get-changed-files.outputs.changed_files
              , 'backend/services/v3') && ! contains(
              needs.get-changed-files.outputs.changed_files,
              'backend/services/v4')) || 'nothing' }}
          - LDAP_ENABLED:
              ${{ (! contains(needs.get-changed-files.outputs.changed_files
              , 'ldap')) || 'nothing' }}
          - OIDC_ENABLED:
              ${{ (! contains(needs.get-changed-files.outputs.changed_files
              , 'keycloak') && ! contains(
              needs.get-changed-files.outputs.changed_files, 'oidc'))
              || 'nothing' }}
          - DEV:
              ${{ (! contains(needs.get-changed-files.outputs.changed_files
              , 'dev')) || 'nothing' }}
    steps:
      - uses: actions/checkout@v4
      - name: Test compose.yaml
        run: |-
          export JOBS_ENABLED=${{ matrix.ELASTIC_OR_JOBS_ENABLED }}
          export ELASTIC_ENABLED=${{ matrix.ELASTIC_OR_JOBS_ENABLED }}
          export LDAP_ENABLED=${{ matrix.LDAP_ENABLED }}
          export OIDC_ENABLED=${{ matrix.OIDC_ENABLED }}
          export BE_VERSION=${{ matrix.BE_VERSION }}
          export DEV=${{ matrix.DEV }}
          docker compose --profile '*' up --wait --wait-timeout 600
