version: '3'
include:
  - ./config/backend/docker-compose.yaml
  - ./config/frontend/docker-compose.yaml
  - ./config/searchapi/docker-compose.yaml
  - ./config/proxy/docker-compose.yaml
services:
  mongodb:
    image: mongo:7.0
    volumes:
      - "mongodb_data:/data/db"
      - "./seed_db/init.js:/docker-entrypoint-initdb.d/init.js"
      - "./seed_db/seed:/seed"
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    labels:
      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.localhost`)"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"
    volumes:
      - 'rabbitmq_data:/bitnami'
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      start_period: 5s
      interval: 30s
      timeout: 10s
      retries: 5
  archive-mock:
    build: https://github.com/SwissOpenEM/ScicatArchiveMock.git
    depends_on:
      rabbitmq:
        condition: service_healthy
      backend:
        condition: service_started
    environment:
      SCI_URL: "http://backend:3000/api/v3/"
      SCI_USER: "admin"
      SCI_PW: "2jf70TPNZsS" 
      RMQ_URL: "rabbitmq"
      RMQ_USER: "guest"
      RMQ_PW: "guest"
volumes:
  mongodb_data:
    driver: local
  rabbitmq_data:
    driver: local
